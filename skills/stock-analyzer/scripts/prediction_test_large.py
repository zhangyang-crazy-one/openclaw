#!/usr/bin/env python3
"""
Aè‚¡é¢„æµ‹æ¨¡å‹éªŒè¯æµ‹è¯• - æ‰©å¤§è§„æ¨¡ç‰ˆ
ä½¿ç”¨2å¹´å†å²æ•°æ®è®­ç»ƒï¼Œé¢„æµ‹2026å¹´2æœˆäº¤æ˜“æ•°æ®ï¼Œæµ‹è¯•100åªè‚¡ç¥¨
"""
import os
import sys
import json
import warnings
import random
from datetime import datetime, timedelta
from pathlib import Path
import numpy as np
import pandas as pd

warnings.filterwarnings('ignore')

# é…ç½®
DATA_DIR = Path("/home/liujerry/é‡‘èæ•°æ®/stocks")
OUTPUT_DIR = Path("/home/liujerry/é‡‘èæ•°æ®/predictions")
OUTPUT_DIR.mkdir(parents=True, exist_ok=True)

# å¸¸ç”¨è‚¡ç¥¨åç§°æ˜ å°„
NAME_MAP = {
    '600519': 'è´µå·èŒ…å°', '601398': 'å·¥å•†é“¶è¡Œ', '600036': 'æ‹›å•†é“¶è¡Œ',
    '601288': 'å†œä¸šé“¶è¡Œ', '601939': 'å»ºè®¾é“¶è¡Œ', '601988': 'ä¸­å›½é“¶è¡Œ',
    '600030': 'ä¸­ä¿¡è¯åˆ¸', '000001': 'å¹³å®‰é“¶è¡Œ', '000002': 'ä¸‡  ç§‘ï¼¡',
    '300750': 'å®å¾·æ—¶ä»£', '002594': 'æ¯”äºšè¿ª', '600028': 'ä¸­å›½çŸ³åŒ–',
    '000651': 'æ ¼åŠ›ç”µå™¨', '603986': 'å…†æ˜“åˆ›æ–°', '300760': 'è¿ˆä¸ºè‚¡ä»½',
    '600016': 'æ°‘ç”Ÿé“¶è¡Œ', '600000': 'æµ¦å‘é“¶è¡Œ', '600015': 'åå¤é“¶è¡Œ',
    '000538': 'äº‘å—ç™½è¯', '000725': 'äº¬ä¸œæ–¹A', '000783': 'é•¿æ±Ÿè¯åˆ¸',
    '600050': 'ä¸­å›½è”é€š', '600104': 'ä¸Šæ±½é›†å›¢', '600276': 'æ’ç‘åŒ»è¯',
    '600309': 'ä¸‡ååŒ–å­¦', '600352': 'æµ™æ±Ÿé¾™ç››', '600362': 'æ±Ÿè¥¿é“œä¸š',
    '600372': 'ä¸­èˆªç”µå­', '600383': 'å±±ä¸œé‡‘æ³°', '600390': 'ä¸­å›½æŠ€æœ¯',
    '600406': 'å›½ç”µå—ç‘', '600420': 'ç°ä»£åˆ¶è¯', '600422': 'æ˜†è¯é›†å›¢',
    '600426': 'åé²æ’å‡', '600436': 'ç‰‡ä»”ç™€', '600446': 'é‡‘è¯è‚¡ä»½',
    '600452': 'æ¶ªé™µç”µåŠ›', '600458': 'æ—¶ä»£æ–°æ', '600467': 'å¥½æƒ³ä½ ',
    '600478': 'ç§‘åŠ›è¿œ', '600479': 'åƒé‡‘è¯ä¸š', '600482': 'ä¸­å›½åŠ¨åŠ›',
    '600487': 'äº¨é€šå…‰ç”µ', '600489': 'ä¸­é‡‘é»„é‡‘', '600493': 'å‡¤ç«¹çººç»‡',
    '600497': 'é©°å®é”Œé”—', '600498': 'çƒ½ç«é€šä¿¡', '600499': 'ç§‘è¾¾æ´èƒ½',
    '600500': 'æ»¨åŒ–è‚¡ä»½', '600502': 'å®‰å¾½æ°´åˆ©', '600503': 'åä¸½å®¶æ—',
    '600505': 'è¥¿æ˜Œç”µåŠ›', '600507': 'æ–¹å¤§ç‰¹é’¢', '600508': 'ä¸Šæµ·èƒ½æº',
    '600509': 'å¤©å¯Œèƒ½æº', '600510': 'é»‘ ç‰¡ ä¸¹', '600511': 'å›½è¯è‚¡ä»½',
    '600512': 'è…¾è¾¾å»ºè®¾', '600513': 'è”ç¯è¯ä¸š', '600516': 'æ–¹å¤§ç‚­ç´ ',
    '600517': 'ç½®ä¿¡ç”µæ°”', '600518': 'åº·ç¾è¯ä¸š', '600519': 'è´µå·èŒ…å°',
    '600520': 'æ–‡ä¸€ç§‘æŠ€', '600521': 'åé’°çŸ¿ä¸š', '600522': 'ä¸­å¤©ç§‘æŠ€',
    '600523': 'è´µèˆªè‚¡ä»½', '600525': 'é•¿å›­é›†å›¢', '600526': 'è²è¾¾ç¯ä¿',
    '600527': 'æ±Ÿå—é«˜çº¤', '600528': 'ä¸­é“å·¥ä¸š', '600529': 'å±±ä¸œè¯ç»',
    '600530': 'äº¤å¤§æ˜‚ç«‹', '600531': 'è±«å…‰é‡‘é“…', '600532': 'å®è¾¾çŸ¿ä¸š',
    '600533': 'æ –éœå»ºè®¾', '600535': 'å¤©  å£«  åŠ›', '600536': 'ä¸­å›½è½¯ä»¶',
    '600537': 'å›½å…‰ç”µ', '600538': 'å›½å‘è‚¡ä»½', '600539': 'ç‹®å¤´è‚¡ä»½',
    '600540': 'æ–°èµ›è‚¡ä»½', '600541': 'å…‰ç”µè‚¡ä»½', '600542': 'æ­Œåæœ‰çº¿',
    '600543': 'è«é«˜è‚¡ä»½', '600545': 'å“ç¿¼ç§‘æŠ€', '600546': 'å±±ç…¤å›½é™…',
    '600547': 'å±±ä¸œé»„é‡‘', '600548': 'æ·±  é«˜  é€Ÿ', '600549': 'é’å²›é‡‘ç‹',
    '600550': 'ä¿å˜ç”µæ°”', '600551': 'æ—¶ä»£å‡ºç‰ˆ', '600552': 'å‡¯ç››ç§‘æŠ€',
    '600553': 'æ²³åŒ—å®£å·¥', '600555': 'æµ·  èº  åˆ›  ä¸š', '600556': 'å¤©ä¸‹ç§€',
    '600557': 'åº·æ³°å¥åº·', '600558': 'å¤§  è¥¿  æ´‹', '600559': 'é‡‘  ä¸–  ç•Œ',
    '600560': 'é‡‘  è‡ª å¤©  æ­£', '600561': 'æ±Ÿè¥¿é•¿è¿', '600562': 'å›½æŠ•ç”µåŠ›',
    '600563': 'å›½  æ³•  æ‹‰', '600564': 'å®œ  å®¾  åˆ¶  é€ ', '600565': 'æ»‡æ± æ°´åŠ¡',
    '600566': 'æµ  å·  è¯  ä¸š', '600567': 'å±±é¹°å›½é™…', '600568': 'ä¸­  ç   æ§  è‚¡',
    '600569': 'å®‰  é˜³  é’¢  é“', '600570': 'æ’  ç”Ÿ  ç”µ  å­', '600571': 'ä¿¡  é›…  è¾¾',
    '600572': 'åº·  æ©  è´', '600573': 'æƒ   æ³‰  å•¤  é…’', '600574': 'ä¸­  çŸ¿  èµ„  æº',
    '600575': 'çš–  æ±Ÿ  ç‰©  æµ', '600576': 'ä¸‡  å®¶  ä¹', '600577': 'ç²¾  è¾¾  è‚¡  ä»½',
    '600578': 'äº¬  èƒ½  ç”µ  åŠ›', '600579': 'å…‹  åŠ³  æ–¯', '600580': 'å§  é¾™  ç”µ æ°”',
    '600581': 'æ–°  å¤©  ç§‘  æŠ€', '600582': 'å¤©  åœ°  ç§‘  æŠ€', '600583': 'æµ·  æ²¹  å·¥ ç¨‹',
    '600584': 'é•¿  ç”µ  ç§‘  æŠ€', '600585': 'æµ·  èº  æ°´  æ³¥', '600586': 'é‡‘  æ™¶  ç§‘  æŠ€',
    '600587': 'æ–°  å  åŒ»  ç–—', '600588': 'ç”¨  å‹  ç½‘  ç»œ', '600589': 'å¹¿  ä¸œ  æ¦•  ç§¦',
    '600590': 'æ³°  è±ª  ç§‘  æŠ€', '600592': 'é¾™  æºª  è‚¡  ä»½', '600593': 'å¤§  è¿  åœ£  äºš',
    '600594': 'ç›Š  ä½°  åˆ¶  è¯', '600595': 'ä¸­  æ³°  æ ¸  ç”µ', '600596': 'æ–°  æ˜Ÿ  åŒ–  å­¦',
    '600597': 'å…‰  æ˜  ä¹³  ä¸š', '600598': 'ä¸­  å›½  ç»  çº¤', '600599': 'æ ª  å†¶  é›†  å›¢',
    '600600': 'é’  å²›  å•¤  é…’', '600601': 'æ–¹  æ­£  ç§‘  æŠ€', '600602': 'äº‘  èµ›  æ™º  è”',
    '600603': 'å¹¿  æ±‡  æ±½  è½¦', '600604': 'å¸‚  åŒ—  é«˜  æ–°', '600605': 'å¤©æ¡¥èµ·é‡',
    '600606': 'ä¸œ  æ–¹  ç”µ  æ°”', '600607': 'ä¸Š  è±  ç”µ  æ°”', '600608': 'ST  æ²ª  ç§‘  æŠ€',
    '600609': 'é‡‘  æ¯  æ±½  è½¦', '600610': 'ä¸­  èˆª  èµ„  æœ¬', '600611': 'å¤§  ä¼—  äº¤  é€š',
    '600612': 'åŒ  æ³°  ç§‘  æŠ€', '600613': 'å›½  æŠ•  æ™º  èƒ½', '600614': 'é¹  èµ·  æ§  è‚¡',
    '600615': 'æƒ   å‘  è‚¡  ä»½', '600616': 'å›½  æŠ•  ç”µ  åŠ›', '600617': 'å›½  æŠ•  æ–°  é›†',
    '600618': 'æ°¯  ç¢±  åŒ–  å·¥', '600619': 'é‡‘  è  è¡—', '600620': 'å¤©  æµ¦  é‡‘  è',
    '600621': 'å  é‘«  è‚¡  ä»½', '600622': 'å›½  æŠ•  ä¸­  é²', '600623': 'å  è°Š  é›†  å›¢',
    '600624': 'å  è°Š  å…„  å¼Ÿ', '600625': 'PT  æ°´  ä»™', '600626': 'ç”³  è¾¾  è‚¡  ä»½',
    '600627': 'ä¸Š  ç”µ  è‚¡  ä»½', '600628': 'ä¸–  ç•Œ  å¹¿  åœº', '600629': 'å  æ§  èµ›  æ ¼',
    '600630': 'é¾™  å»º  è‚¡  ä»½', '600631': 'ç™¾  è”  è‚¡  ä»½', '600632': 'å  è”  å•†  å¦',
    '600633': 'ç™½  çŒ«  è‚¡  ä»½', '600634': 'å¯Œ  æ˜¥  æ§  è‚¡', '600635': 'å¤§  ä¼—  å…¬  å…±',
    '600636': 'ä¸‰  çˆ±  å¯Œ', '600637': 'ä¸œ  æ–¹  æ˜  ç ', '600638': 'æ–°  é»„  æµ¦',
    '600639': 'å·  é‡‘  æ£®', '600640': 'å·  ç™¾  æ§  è‚¡', '600641': 'ä¸­  æ¯…  è¾¾',
    '600642': 'ç”³  èƒ½  è‚¡  ä»½', '600643': 'çˆ±  å»º è‚¡  ä»½', '600644': 'ä¹  å±±  ç”µ  åŠ›',
    '600645': 'ä¸­  æº  å  å’Œ', '600646': 'å›½  æŠ•  æ€  è·¯', '600647': 'åŒ  è¾¾  æ§  è‚¡',
    '600648': 'å¤–  é«˜  æ¡¥', '600649': 'åŸ  å»º  æŠ•  èµ„', '600650': 'é”¦  æ±Ÿ  æŠ•  èµ„',
    '600651': 'é£  ä¹  éŸ³  å“', '600652': 'æ¸¸  æ—  ç½‘  ç»œ', '600653': 'å  æ˜   ç§‘  æŠ€',
    '600654': 'é£  ä¹  è‚¡  ä»½', '600655': 'è±«  å›­  è‚¡  ä»½', '600656': 'å  æº  æ§  è‚¡',
    '600657': 'ä¿¡  è¾¾  åœ°  äº§', '600658': 'ç”µ  å­  åŸ', '600659': 'ç¦  å»º  é‡‘  æ£®',
    '600660': 'ç¦  è€€  ç»  ç’ƒ', '600661': 'ç«‹  æ€  è¾°', '600662': 'å¼º  ç”Ÿ  æ§  è‚¡',
    '600663': 'é™†  å®¶  å˜´', '600664': 'å“ˆ  è¯  è‚¡  ä»½', '600665': 'å¤©  æˆ¿  å‘  å±•',
    '600666': 'å¥¥  æ™® å…‰  ç”µ', '600667': 'å¤ª  å¹³  æ´‹', '600668': 'å°–  å³°  é›†  å›¢',
    '600669': 'ç¦  å»º  æ°´  æ³¥', '600670': 'å¤©  é›  æ§  è‚¡', '600671': 'å¤©  ç›®  è¯  ä¸š',
    '600672': 'è‹±  ç§‘  åŒ»  ç–—', '600673': 'ä¸œ  é˜³  å…‰', '600674': 'å·  æŠ•  èƒ½  æº',
    '600675': 'åŸ  å»º  è‚¡  ä»½', '600676': 'äº¤  è¿  è‚¡  ä»½', '600677': 'èˆª  å‘  æ§  è‚¡',
    '600678': 'å›› å· é‡‘  é¡¶', '600679': 'ä¸Š  æµ·  å‡¤  å‡°', '600680': 'ä¸Š  æµ·  æ™®  å¤©',
    '600681': 'ç™¾  å·  èƒ½  æº', '600682': 'å—  äº¬  åŒ»  è¯', '600683': 'äº¬  æŠ•  å‘  å±•',
    '600684': 'ç   æµ·  åŸº  å»º', '600685': 'ä¸­  èˆ¹ é˜²  åŠ¡', '600686': 'ä¸­  å…µ  æ§  è‚¡',
    '600687': 'åˆš  æ³°  æ§  è‚¡', '600688': 'ä¸Š  æµ·  çŸ³  åŒ–', '600689': 'ä¸Š  æµ·  é’¢  è”',
    '600690': 'é’  å²›  æµ·  å°”', '600691': 'é˜³  ç…¤  åŒ–  å·¥', '600692': 'äºš  é€š  è‚¡  ä»½',
    '600693': 'ä¸œ  ç™¾  é›†  å›¢', '600694': 'å¤§  å•† è‚¡  ä»½', '600695': 'ç»¿  åº­  æŠ•  èµ„',
    '600696': 'ST  çƒ  å† ', '600697': 'æ¬§  äºš  é›†  å›¢', '600698': 'æ¹–  å—  å¤©  é›',
    '600699': 'å‡  èƒœ  ç”µ  å­', '600700': 'æ¬§  äºš  é›†  å›¢', '600701': 'é£  åŸ  ç‚’  ä½œ',
    '600702': 'èˆ  å¾—  é…’  ä¸š', '600703': 'ä¸‰ å®‰ å…‰  ç”µ', '600704': 'ç‰©  äº§ ä¸­  å¤§',
    '600705': 'ä¸­  èˆª  èµ„  æœ¬', '600706': 'æ›²  æ±Ÿ æ–‡  æ—…', '600707': 'å½©  è™¹ è‚¡  ä»½',
    '600708': 'å¤ª  å¹³  æ´‹', '600709': 'è‘µ  èŠ±  è¯  ä¸š', '600710': 'è‹  æ³Š  å°”',
    '600711': 'ç››  å±¯  çŸ¿  ä¸š', '600712': 'å—  å®  ç™¾  è´§', '600713': 'å—  è¯ è‚¡  ä»½',
    '600714': 'é‡‘  ç‘  çŸ¿  ä¸š', '600715': 'æ–‡  å±±  ç”µ  åŠ›', '600716': 'å‡¤  å‡° è‚¡  ä»½',
    '600717': 'å¤©  æ´¥  æ¸¯', '600718': 'ä¸œ  è½¯  é›†  å›¢', '600719': 'å¤§  è¿  çƒ­  ç”µ',
    '600720': 'ç¥  è¿  å±±', '600721': 'ç™¾  èŠ±  æ‘', '600722': 'é‡‘  ç‰›  åŒ–  å·¥',
    '600723': 'é¦–  å•† è‚¡  ä»½', '600724': 'å®  æ³¢ å¯Œ  è¾¾', '600725': 'äº‘  ç»´ è‚¡  ä»½',
    '600726': 'å  æº  æ§ è‚¡', '600727': 'é²  åŒ—  åŒ–  å·¥', '600728': 'ä½³  éƒ½  ç§‘  æŠ€',
    '600729': 'å¥³  äºº  è¡—', '600730': 'ä¸­  å›½ é«˜  ç§‘', '600731': 'æ¹–  å— æµ·  åˆ©',
    '600732': 'çˆ±  æ—­ è‚¡  ä»½', '600733': 'åŒ—  æ±½  è“  è°·', '600734': 'å®  è¾¾  é›†  å›¢',
    '600735': 'æ–°  å  é”¦', '600736': 'è‹  å· é«˜  æ–°', '600737': 'ä¸­  ç²® å±¯  æ²³',
    '600738': 'æ°‘  æ³°  çµ  æ¡¥', '600739': 'è¾½  å® æˆ  å¤§', '600740': 'å±±  è¥¿  ç„¦  åŒ–',
    '600741': 'å  åŸŸ æ±½  è½¦', '600742': 'ä¸€ æ±½ å¯Œ  ç»´', '600743': 'å  è¿œ  åœ°  äº§',
    '600744': 'å  é“¶  ç”µ åŠ›', '600745': 'åº·  å°¼ æœº ç”µ', '600746': 'æ±Ÿ  è‹  ç´¢  æ™®',
    '600747': 'å¤§  è¿  æ§  è‚¡', '600748': 'ä¸Š  å® å‘  å±•', '600749': 'è—  æ—…  æ¸¸',
    '600750': 'æ±Ÿ  è¥¿  å¤©  æ–½', '600751': 'å¤©  æ´¥  æµ·  è¿', '600752': 'å“ˆ  æŠ• è‚¡  ä»½',
    '600753': 'ä¸œ  æ–¹  é“¶  æ˜Ÿ', '600754': 'é”¦ æ±Ÿ è‚¡  ä»½', '600755': 'å¦  é—¨ å›½  è´¸',
    '600756': 'æµªæ½® è½¯ ä»¶', '600757': 'å  æº  èƒ½  æº', '600758': 'è¾½  æ²³  æ²¹  ç”°',
    '600759': 'æ´²  é™…  æ²¹  æ°”', '600760': 'ä¸­  èˆª é‡  æœº', '600761': 'å®‰  å¾½ åˆ  åŠ›',
    '600762': 'é‡‘  è¯š ä¿¡', '600763': 'é€š  ç­–  åŒ»  ç–—', '600764': 'ä¸­  å›½ æµ·  é˜²',
    '600765': 'ä¸­  èˆª  åŠ¨  åŠ›', '600766': 'å›­  æ— è‚¡  ä»½', '600767': 'è¿  ç››  åŒ»  ç–—',
    '600768': 'å®  æ³¢  å¯Œ  é‚¦', '600769': 'ç¥¥  é¾™ ç”µ  ä¸š', '600770': 'å•†  ä¸š  åŸ',
    '600771': 'å¤©  ä¸š è‚¡  ä»½', '600772': 'æ–°  æ½® èƒ½  æº', '600773': 'è¥¿  è—  åŸ  æŠ•',
    '600774': 'æ±‰  å•†  é›†  å›¢', '600775': 'å—  äº¬ ç†Š  çŒ«', '600776': 'ä¸œ  æ–¹  é€š  ä¿¡',
    '600777': 'ç›ˆ  ç§‘  åŒ»  ç–—', '600778': 'å¤§  ä¼—  å…¬  å…±', '600779': 'æ°´  äº•  åŠ',
    '600780': 'é€š  å® èƒ½  æº', '600781': 'è¾…  ä»  è¯  ä¸š', '600782': 'æ–°  å  é’¢  é“',
    '600783': 'é²  ä¿¡  åˆ›  æŠ•', '600784': 'é²  é“¶  æŠ•  èµ„', '600785': 'æ–°  å ç™¾  è´§',
    '600786': 'ä¸­  æ²¹  å·¥ ç¨‹', '600787': 'ä¸­  å‚¨ è‚¡  ä»½', '600788': 'å¾·  æ£‰ è‚¡  ä»½',
    '600789': 'é²  æŠ—  åŒ»  è¯', '600790': 'è½»  çºº  åŸ', '600791': 'äº¬  èƒ½ ç”µ  åŠ›',
    '600792': 'äº‘  ç…¤ èƒ½  æº', '600793': 'å®œ  å®¾  çº¸  ä¸š', '600794': 'ä¿ ç¨  ç§‘  æŠ€',
    '600795': 'åŒ—  æ–¹  ç¡  é…¸', '600796': 'é’±  æ±Ÿ ç”Ÿ  åŒ–', '600797': 'æµ™  å¤§  ç½‘  æ–°',
    '600798': 'å®  æ³¢ æµ·  è¿', '600799': 'è‹  æ³Š  å°”', '600800': 'å¤©  æ´¥  ç£  å¡',
    '600801': 'å  æ–° æ°´  æ³¥', '600802': 'ç¦  å»º æ°´  æ³¥', '600803': 'æ–°  å¥¥ è‚¡  ä»½',
    '600804': 'ä¸Š  æ±½  é›†  å›¢', '600805': 'æ‚¦  è¾¾  æŠ•  èµ„', '600806': 'é€€ å¸‚  ç”³  å',
    '600807': 'å¤©  ä¸š è‚¡  ä»½', '600808': 'é©¬  é’¢ è‚¡  ä»½', '600809': 'å±±  è¥¿  æ±¾  é…’',
    '600810': 'ç¥  é©¬ è‚¡  ä»½', '600811': 'ä¸­ å›½  é‡‘è', '600812': 'å  åŒ— åˆ¶  è¯',
    '600813': 'ä¸œ  åŒ—  é«˜  æ–°', '600814': 'è§£  æ”¾  é›†  å›¢', '600815': 'å¦  å·¥ è‚¡  ä»½',
    '600816': 'å®‰  ä¿¡ ä¿¡  æ‰˜', '600817': 'é€š  å·  ç”µ  å­', '600818': 'ä¸­  è·¯ è‚¡  ä»½',
    '600819': 'è€€  çš®  ç»  ç’ƒ', '600820': 'éš§  é“ è‚¡  ä»½', '600821': 'å¤©  æ´¥  åŠ  ä¸š',
    '600822': 'ä¸‡  ä¸°  å¥¥  å¨', '600823': 'ä¸–  èŒ‚ è‚¡  ä»½', '600824': 'ç›Š  æ°‘  é›†  å›¢',
    '600825': 'æ–°  å  ä¼   åª’', '600826': 'å…°  å· æ°‘  ç™¾', '600827': 'ç™¾  è” è‚¡  ä»½',
    '600828': 'æˆ  éƒ½ å•†  åœº', '600829': 'äºº  æ°‘ åŒ  æ³°', '600830': 'é¦™  æº¢  è  é€š',
    '600831': 'å¹¿ç”µ  ç½‘ç»œ', '600832': 'ä¸œ  æ–¹ æ˜  ç ', '600833': 'åŒ—  åŒ»è¯',
    '600834': 'å‡Œ  æ¡¥ æ°´  åŠ¡', '600835': 'ä¸Š  æµ· æœº  ç”µ', '600836': 'ç•Œ  é¾™ å®  ä¸š',
    '600837': 'æµ·  éš†  è½¯ ä»¶', '600838': 'ä¸Š æµ· ä¹ ç™¾', '600839': 'å›› å· é•¿ è™¹',
    '600840': 'æµ™  æ±Ÿ ä¸œ  æ—¥', '600841': 'ä¸Š  æŸ´ è‚¡  ä»½', '600842': 'ä¸­  è¥¿  è¯  ä¸š',
    '600843': 'ä¸Š  å·¥  ç”³  è´', '600844': 'ä¸¹  åŒ–  ç§‘  æŠ€', '600845': 'å®  ä¿¡ è½¯  ä»¶',
    '600846': 'åŒ  æµ  ç§‘  æŠ€', '600847': 'ä¸‡  é‡Œ è‚¡  ä»½', '600848': 'ä¸Š  æµ·  ä¸´  æ¸¯',
    '600849': 'ä¸Š  æµ·  åŒ»  è¯', '600850': 'å  ä¸œ ç”µ è„‘', '600851': 'èˆª  å‘  æ§  è‚¡',
    '600852': 'ä¸­  æ²¹  å·¥  ç¨‹', '600853': 'åŒ—  æ–° è·¯  æ¡¥', '600854': 'æ˜¥  é£  åŠ¨  åŠ›',
    '600855': 'èˆª  å¤© é•¿  å³°', '600856': 'ä¸­  å¤© èƒ½  æº', '600857': 'å“ˆ  æŠ• è‚¡  ä»½',
    '600858': 'é“¶  åº§ è‚¡  ä»½', '600859': 'ç‹  åºœ  äº•', '600860': 'äº¬  åŸ è‚¡  ä»½',
    '600861': 'åŒ—  äº¬  åŸ  ä¹¡', '600862': 'å  æ¶¦ åŒ  é¹¤', '600863': 'å†…  è’™  ä¸€  æœº',
    '600864': 'å—  äº¬ é«˜  ç§‘', '600865': 'ç™¾  è” è‚¡  ä»½', '600866': 'æˆ  å‘  ç§‘  æŠ€',
    '600867': 'é€š  åŒ– ä¸œ  å®', '600868': 'æ¢…  é›  å‰  ç¥¥', '600869': 'è¿œ  èˆª  ç   å¯Œ',
    '600870': 'ST  å¦  å', '600871': 'ä¸­  åŒ– å²©  åœŸ', '600872': 'ä¸­  ç§‘  åˆ›  è¾¾',
    '600873': 'æ–°  ç–† äº¤  å»º', '600874': 'å¤©  æ´¥  åŒ–  å·¥', '600875': 'ä¸œ  æ–¹  ç”µ  æ°”',
    '600876': 'æ´›  é˜³  ç»  ç’ƒ', '600877': 'ç”µ  ç§‘  è£…  å¤‡', '600878': 'åŒ—  åŒ– è‚¡  ä»½',
    '600879': 'èˆª  å¤© ç”µ  å­', '600880': 'åš  ç‘  ä¼   æ’­', '600881': 'äºš  æ³°  é›†  å›¢',
    '600882': 'å  è” è‚¡  ä»½', '600883': 'åš  å…ƒ  æŠ•  èµ„', '600884': 'æ‰  æ‰ è‚¡  ä»½',
    '600885': 'å®  å‘ è‚¡  ä»½', '600886': 'å›½  æŠ•  ç”µ  åŠ›', '600887': 'ä¼Š  åˆ© è‚¡  ä»½',
    '600888': 'ä¸­  é“ å›½  é™…', '600889': 'å—  äº¬ èš  éš†', '600890': 'å¤§  å†¶  é’¢  é“',
    '600891': 'ç§‹ æ—  é›†  å›¢', '600892': 'å¤§  æ™Ÿ æ–‡  åŒ–', '600893': 'ä¸­  èˆª  åŠ¨  åŠ›',
    '600894': 'å¹¿  æ—¥ è‚¡  ä»½', '600895': 'å¼   æ±Ÿ é«˜  ç§‘', '600896': 'ä¸­  å›½  å›½  è´¸',
    '600897': 'å¦  é—¨ ä¿¡  è¾¾', '600898': 'å›½  ç¾  é€š  è®¯', '600899': 'ä¿¡  å¨  é€š  ä¿¡',
}

def get_stock_name(code):
    """è·å–è‚¡ç¥¨åç§°"""
    return NAME_MAP.get(code, f"è‚¡ç¥¨{code}")

def load_stock_data(code):
    """åŠ è½½è‚¡ç¥¨æ•°æ®"""
    filepath = DATA_DIR / f"{code}.csv"
    if not filepath.exists():
        return None
    
    try:
        df = pd.read_csv(filepath, encoding='utf-8-sig')
        n_cols = df.shape[1]
        
        if n_cols == 2:
            df.columns = ['date', 'close']
        elif n_cols == 6:
            pass  # åˆ—åå·²ç»æ­£ç¡®
        elif n_cols == 12:
            df.columns = ['date', 'code', 'open', 'close', 'high', 'low', 
                         'volume', 'amount', 'amplitude', 'pct_change', 
                         'change', 'turnover']
            df = df[['date', 'open', 'close', 'high', 'low', 'volume']]
        else:
            return None
        
        df['date'] = pd.to_datetime(df['date'])
        df = df.sort_values('date').reset_index(drop=True)
        
        for col in ['open', 'close', 'high', 'low']:
            if col in df.columns:
                df[col] = pd.to_numeric(df[col], errors='coerce')
        if 'volume' in df.columns:
            df['volume'] = pd.to_numeric(df['volume'], errors='coerce')
        if 'volume' not in df.columns:
            df['volume'] = 1.0
        
        return df
    except Exception as e:
        return None

def calculate_technical_features(df):
    """è®¡ç®—æŠ€æœ¯æŒ‡æ ‡ç‰¹å¾"""
    df = df.copy()
    
    df['return'] = df['close'].pct_change()
    df['log_return'] = np.log(df['close'] / df['close'].shift(1))
    
    for window in [5, 10, 20, 60]:
        df[f'ma_{window}'] = df['close'].rolling(window=window).mean()
        df[f'ma_ratio_{window}'] = df['close'] / df[f'ma_{window}']
    
    df['volatility_5'] = df['return'].rolling(window=5).std()
    df['volatility_20'] = df['return'].rolling(window=20).std()
    
    for period in [7, 14, 21]:
        delta = df['close'].diff()
        gain = delta.where(delta > 0, 0).rolling(window=period).mean()
        loss = (-delta.where(delta < 0, 0)).rolling(window=period).mean()
        rs = gain / loss
        df[f'rsi_{period}'] = 100 - (100 / (1 + rs))
    
    ema_12 = df['close'].ewm(span=12, adjust=False).mean()
    ema_26 = df['close'].ewm(span=26, adjust=False).mean()
    df['macd'] = ema_12 - ema_26
    df['macd_signal'] = df['macd'].ewm(span=9, adjust=False).mean()
    df['macd_hist'] = df['macd'] - df['macd_signal']
    
    for period in [20]:
        df[f'bb_mid_{period}'] = df['close'].rolling(window=period).mean()
        bb_std = df['close'].rolling(window=period).std()
        df[f'bb_upper_{period}'] = df[f'bb_mid_{period}'] + 2 * bb_std
        df[f'bb_lower_{period}'] = df[f'bb_mid_{period}'] - 2 * bb_std
        df[f'bb_width_{period}'] = (df[f'bb_upper_{period}'] - df[f'bb_lower_{period}']) / df[f'bb_mid_{period}']
        df[f'bb_position_{period}'] = (df['close'] - df[f'bb_lower_{period}']) / (df[f'bb_upper_{period}'] - df[f'bb_lower_{period}'])
    
    df['volume_ma_5'] = df['volume'].rolling(window=5).mean()
    df['volume_ratio'] = df['volume'] / df['volume_ma_5']
    
    for period in [5, 10, 20]:
        df[f'momentum_{period}'] = df['close'] / df['close'].shift(period) - 1
    
    return df

def prepare_features(df, feature_cols):
    """å‡†å¤‡ç‰¹å¾çŸ©é˜µ"""
    df_clean = df.dropna(subset=feature_cols).copy()
    return df_clean

def train_model(X_train, y_train):
    """è®­ç»ƒéšæœºæ£®æ—æ¨¡å‹"""
    from sklearn.ensemble import RandomForestRegressor
    
    model = RandomForestRegressor(
        n_estimators=100,
        max_depth=15,
        min_samples_split=5,
        random_state=42,
        n_jobs=-1
    )
    model.fit(X_train, y_train)
    return model

def evaluate_prediction(actual, predicted):
    """è¯„ä¼°é¢„æµ‹å‡†ç¡®æ€§"""
    actual = np.array(actual)
    predicted = np.array(predicted)
    
    mae = np.mean(np.abs(actual - predicted))
    rmse = np.sqrt(np.mean((actual - predicted) ** 2))
    mape = np.mean(np.abs((actual - predicted) / actual)) * 100
    
    actual_dir = np.sign(np.diff(actual))
    pred_dir = np.sign(np.diff(predicted))
    direction_acc = np.mean(actual_dir == pred_dir) * 100
    
    return {'MAE': mae, 'RMSE': rmse, 'MAPE': mape, 'direction_accuracy': direction_acc}

def run_prediction_test():
    """è¿è¡Œé¢„æµ‹æµ‹è¯•"""
    print("=" * 80)
    print("ğŸ¤– Aè‚¡é¢„æµ‹æ¨¡å‹éªŒè¯æµ‹è¯• - 100åªè‚¡ç¥¨å¤§è§„æ¨¡ç‰ˆ")
    print("=" * 80)
    
    # ç‰¹å¾åˆ—
    feature_cols = [
        'return', 'log_return', 'ma_ratio_5', 'ma_ratio_10', 'ma_ratio_20',
        'volatility_5', 'volatility_20', 'rsi_14', 'macd', 'macd_signal',
        'macd_hist', 'bb_position_20', 'volume_ratio', 'momentum_5', 'momentum_10'
    ]
    
    # è·å–æ‰€æœ‰è‚¡ç¥¨æ–‡ä»¶
    all_stocks = []
    for f in DATA_DIR.glob("*.csv"):
        code = f.stem
        if code.isdigit() and len(code) == 6:
            all_stocks.append(code)
    
    print(f"\nğŸ“Š å¯ç”¨è‚¡ç¥¨æ€»æ•°: {len(all_stocks)}")
    
    # éšæœºé€‰æ‹©100åªè‚¡ç¥¨
    random.seed(42)
    test_stocks = random.sample(all_stocks, min(100, len(all_stocks)))
    
    # æ·»åŠ è“ç­¹è‚¡ç¡®ä¿è¦†ç›–
    blue_chips = ['600519', '601398', '600036', '601288', '601939', '601988', '600028', '000651']
    for chip in blue_chips:
        if chip not in test_stocks and chip in all_stocks:
            test_stocks.append(chip)
            if len(test_stocks) >= 100:
                break
    
    test_stocks = test_stocks[:100]
    print(f"ğŸ“Š æµ‹è¯•è‚¡ç¥¨æ•°é‡: {len(test_stocks)}")
    
    results = []
    
    for code in test_stocks:
        name = get_stock_name(code)
        
        df = load_stock_data(code)
        if df is None or len(df) < 500:  # éœ€è¦è¶³å¤Ÿçš„å†å²æ•°æ®ï¼ˆ2å¹´çº¦500äº¤æ˜“æ—¥ï¼‰
            continue
        
        # è®¡ç®—ç‰¹å¾
        df = calculate_technical_features(df)
        
        # åˆ†ç¦»è®­ç»ƒæ•°æ®å’Œæµ‹è¯•æ•°æ®
        # è®­ç»ƒ: 2024-01-01 ~ 2026-01-31 (2å¹´å†å²)
        # æµ‹è¯•: 2026-02-01 ~ 2026-02-06
        train_df = df[df['date'] < '2026-02-01'].copy()
        test_df = df[(df['date'] >= '2026-02-01') & (df['date'] <= '2026-02-06')].copy()
        
        if len(test_df) < 3:
            continue
        
        train_df = prepare_features(train_df, feature_cols)
        
        if len(train_df) < 200:
            continue
        
        # å‡†å¤‡è®­ç»ƒæ•°æ®
        X_train = train_df[feature_cols].values
        y_train = train_df['close'].values
        
        # è®­ç»ƒæ¨¡å‹
        model = train_model(X_train, y_train)
        
        # é¢„æµ‹
        predictions = []
        actuals = []
        dates = []
        
        for idx, row in test_df.iterrows():
            features = row[feature_cols].values.astype(float)
            
            if not np.any(np.isnan(features)):
                pred = model.predict(features.reshape(1, -1))[0]
                predictions.append(pred)
                actuals.append(row['close'])
                dates.append(row['date'])
        
        if len(predictions) < 2:
            continue
        
        # è¯„ä¼°
        metrics = evaluate_prediction(actuals, predictions)
        
        results.append({
            'code': code,
            'name': name,
            'actual_last': actuals[-1],
            'predicted_last': predictions[-1],
            'mape': metrics['MAPE'],
            'direction_acc': metrics['direction_accuracy'],
        })
        
        # æ¯10åªè‚¡ç¥¨è¾“å‡ºä¸€æ¬¡è¿›åº¦
        if len(results) % 10 == 0:
            print(f"  å·²å®Œæˆ {len(results)}/100 åªè‚¡ç¥¨...")
    
    # æ±‡æ€»ç»“æœ
    print("\n" + "=" * 80)
    print("ğŸ“Š é¢„æµ‹ç»“æœæ±‡æ€»")
    print("=" * 80)
    
    if not results:
        print("âŒ æ²¡æœ‰æœ‰æ•ˆçš„æµ‹è¯•ç»“æœ")
        return
    
    total_mape = np.mean([r['mape'] for r in results])
    total_dir_acc = np.mean([r['direction_acc'] for r in results])
    
    print(f"\nâœ… æˆåŠŸæµ‹è¯• {len(results)} åªè‚¡ç¥¨")
    print(f"ğŸ“Š å¹³å‡MAPE: {total_mape:.2f}%")
    print(f"ğŸ“Š å¹³å‡æ–¹å‘å‡†ç¡®ç‡: {total_dir_acc:.1f}%")
    
    print(f"\nğŸ“‹ è¯¦ç»†ç»“æœ:")
    print("-" * 80)
    print(f"{'ä»£ç ':<10} {'åç§°':<12} {'å®é™…æ”¶ç›˜':<12} {'é¢„æµ‹æ”¶ç›˜':<12} {'MAPE':<10} {'æ–¹å‘å‡†ç¡®ç‡':<10}")
    print("-" * 80)
    
    for r in sorted(results, key=lambda x: x['mape'])[:50]:
        print(f"{r['code']:<10} {r['name']:<12} {r['actual_last']:<12.2f} {r['predicted_last']:<12.2f} {r['mape']:<10.2f}% {r['direction_acc']:<10.1f}%")
    
    # åˆ†ç±»ç»Ÿè®¡
    excellent = [r for r in results if r['mape'] < 3]
    good = [r for r in results if 3 <= r['mape'] < 10]
    fair = [r for r in results if 10 <= r['mape'] < 20]
    poor = [r for r in results if r['mape'] >= 20]
    
    print(f"\nğŸ“ˆ é¢„æµ‹å‡†ç¡®æ€§åˆ†ç±»:")
    print(f"  ğŸŸ¢ ä¼˜ç§€ (MAPE<3%): {len(excellent)} åª ({len(excellent)/len(results)*100:.1f}%)")
    print(f"  ğŸŸ¡ è‰¯å¥½ (3-10%): {len(good)} åª ({len(good)/len(results)*100:.1f}%)")
    print(f"  ğŸŸ  ä¸€èˆ¬ (10-20%): {len(fair)} åª ({len(fair)/len(results)*100:.1f}%)")
    print(f"  ğŸ”´ è¾ƒå·® (>20%): {len(poor)} åª ({len(poor)/len(results)*100:.1f}%)")
    
    # ä¿å­˜ç»“æœ
    output_file = OUTPUT_DIR / "prediction_test_100stocks.json"
    with open(output_file, 'w', encoding='utf-8') as f:
        json.dump({
            'test_date': datetime.now().isoformat(),
            'stocks_tested': len(results),
            'total_mape': total_mape,
            'total_direction_accuracy': total_dir_acc,
            'excellent': len(excellent),
            'good': len(good),
            'fair': len(fair),
            'poor': len(poor),
            'results': results
        }, f, ensure_ascii=False, indent=2)
    
    print(f"\nğŸ’¾ ç»“æœå·²ä¿å­˜è‡³: {output_file}")
    
    return results

if __name__ == "__main__":
    run_prediction_test()
